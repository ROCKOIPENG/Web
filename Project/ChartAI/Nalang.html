<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI聊天</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e5799, #207cca, #2989d8, #1e5799);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* 聊天头部 */
        .chat-header {
            background: #0084ff;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 10;
        }
        
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #43e97b, #38f9d7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-info h3 {
            font-size: 18px;
        }
        
        .chat-info p {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .chat-actions {
            display: flex;
            gap: 15px;
        }
        
        .chat-actions i {
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }
        
        .chat-actions i:hover {
            transform: scale(1.1);
        }
        
        /* 聊天区域 */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #e5e5e5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="none" stroke="gray" stroke-width="1"/></svg>');
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 8px;
            position: relative;
            animation: fadeIn 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            align-self: flex-end;
            background: #95ec69;
            border-top-right-radius: 0;
        }
        
        .message.assistant {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .message .content {
            font-size: 15px;
            line-height: 1.5;
        }
        
        .message .time {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-action {
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #555;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .message-action:hover {
            background: rgba(0,0,0,0.2);
        }
        
        /* 输入区域 */
        .chat-input-container {
            padding: 15px;
            background: #f0f2f5;
            border-top: 1px solid #d1d7db;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .chat-input i {
            color: #888;
            margin: 0 8px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .chat-input i:hover {
            color: #0084ff;
        }
        
        .chat-input textarea {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 15px;
            height: 22px;
            max-height: 100px;
            padding: 0 5px;
            background: transparent;
        }
        
        .send-button {
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 132, 255, 0.4);
        }
        
        .send-button:hover {
            background: #0073e6;
            transform: translateY(-2px);
        }
        
        .send-button i {
            font-size: 18px;
        }
        
        /* TTS控制面板 */
        .tts-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #d1d7db;
        }
        
        .tts-slider {
            flex: 1;
        }
        
        .tts-buttons {
            display: flex;
            gap: 5px;
        }
        
        .tts-btn {
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .tts-btn:hover {
            background: #0066cc;
        }
        
        .tts-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .tts-btn.stop {
            background: #dc3545;
        }
        
        .tts-btn.stop:hover {
            background: #bd2130;
        }
        
        .tts-btn.pause {
            background: #ffc107;
            color: #333;
        }
        
        .tts-btn.pause:hover {
            background: #e0a800;
        }
        
        /* 语音播放动画 */
        .voice-wave {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 2px;
        }
        
        .wave-bar {
            width: 3px;
            background: #0084ff;
            border-radius: 2px;
            animation: wave 1.2s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.2s; height: 60%; }
        .wave-bar:nth-child(3) { animation-delay: 0.4s; height: 80%; }
        .wave-bar:nth-child(4) { animation-delay: 0.6s; height: 100%; }
        .wave-bar:nth-child(5) { animation-delay: 0.8s; height: 80%; }
        .wave-bar:nth-child(6) { animation-delay: 1.0s; height: 60%; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        /* 语音输入按钮 */
        .voice-input-btn {
            background: #ff6b6b;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }
        
        .voice-input-btn:hover {
            background: #e55c5c;
        }
        
        .voice-input-btn.listening {
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .tts-status {
            font-size: 12px;
            color: #666;
            padding: 5px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #d1d7db;
            display: flex;
            justify-content: space-between;
        }
        
        /* API设置面板 */
        .api-settings {
            position: absolute;
            right: -400px;
            top: 0;
            width: 380px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .api-settings.active {
            right: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-header h2 {
            font-size: 18px;
        }
        
        .close-settings {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }
        
        .close-settings:hover {
            color: #f00;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            border-color: #0084ff;
            outline: none;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .settings-button {
            position: absolute;
            right: 13px;
            top: 15px;
            background: #0084ff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 132, 255, 0.4);
            z-index: 90;
            transition: transform 0.2s, background 0.2s;
        }
        
        .settings-button:hover {
            background: #0073e6;
            transform: rotate(30deg);
        }
        
        .settings-button i {
            font-size: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: #28a745;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .status-inactive {
            background-color: #6c757d;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: fit-content;
            margin-bottom: 15px;
            align-self: flex-start;
        }
        
        .typing-dots {
            display: flex;
            align-items: center;
            height: 17px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .token-counter {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .response-info {
            display: flex;
            justify-content: flex-end;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* 导入导出按钮 */
        .import-export {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .import-btn, .export-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .import-btn {
            background: #e9ecef;
            color: #333;
        }
        
        .import-btn:hover {
            background: #dde0e3;
        }
        
        .export-btn {
            background: #0084ff;
            color: white;
        }
        
        .export-btn:hover {
            background: #0073e6;
        }
        
        /* 文件上传样式 */
        #file-input {
            display: none;
        }
        
        /* 底部状态栏 */
        .bottom-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f0f2f5;
            border-top: 1px solid #d1d7db;
            font-size: 12px;
            color: #666;
        }
        
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
        }
        
        @keyframes slideIn {
            from { top: -50px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* TTS兼容性警告 */
        .tts-warning {
            background: #ffc107;
            color: #333;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .tts-warning a {
            color: #007bff;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 聊天头部 -->
        <div class="chat-header">
            <div class="chat-avatar">N</div>
            <div class="chat-info">
                <h3>NaLang AI</h3>
                <p>在线 · <span id="status-text">准备就绪</span></p>
            </div>
            <!-- <div class="chat-actions">
                <i class="fas fa-info-circle" title="系统信息"></i>
            </div> -->
        </div>
        
        <!-- TTS控制面板 -->
        <div class="tts-controls">
            <div class="voice-wave" id="voice-wave">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
            <div class="tts-buttons">
                <button class="tts-btn play" id="tts-play">播放最新</button>
                <button class="tts-btn pause" id="tts-pause" disabled>暂停</button>
                <button class="tts-btn stop" id="tts-stop" disabled>停止</button>
            </div>
        </div>
        <div class="tts-status" id="tts-status">
            <span>TTS状态: 准备就绪</span>
            <span>已用令牌: <span id="token-count">0</span></span>
        </div>
        
        <!-- 聊天区域 -->
        <div class="chat-messages" id="chat-messages">
            <!-- <div class="message assistant">
                <div class="message-actions">
                    <div class="message-action" title="朗读">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
                <div class="content">您好！我是NaLang AI助手，支持完整的TTS功能和数据导入导出功能。</div>
                <div class="time">12:00</div>
            </div>
            <div class="message assistant">
                <div class="message-actions">
                    <div class="message-action" title="朗读">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
                <div class="content">您可以在设置面板中导入导出完整的聊天记录和系统设置。</div>
                <div class="time">12:00</div>
            </div> -->
        </div>
        
        <!-- 输入区域 -->
        <div class="chat-input-container">
            <div class="chat-input">
                <!-- <i class="far fa-smile" title="表情"></i> -->
                <textarea id="message-input" placeholder="输入消息..."></textarea>
                <!-- <i class="fas fa-paperclip" title="附件"></i> -->
                <!-- <i class="fas fa-camera" title="拍照"></i> -->
            </div>
            <button class="voice-input-btn" id="voice-btn" title="语音输入">
                <i class="fas fa-microphone"></i>
            </button>
            <div class="send-button" id="send-btn" title="发送">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        
        <!-- 底部状态栏 -->
        <div class="bottom-bar">
            <div>模型: <span id="model-display">NaLang XL-10</span></div>
            <div>今日消息: <span id="message-count">2</span></div>
        </div>
        
        <!-- API设置面板 -->
        <div class="api-settings" id="api-settings">
            <div class="settings-header">
                <h2>API参数设置</h2>
                <button class="close-settings" id="close-settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- TTS兼容性警告 -->
            <!-- <div class="tts-warning" id="tts-warning">
                <p><strong>数据导入导出功能：</strong> 支持完整保存聊天记录、系统设置和TTS参数</p>
            </div> -->
            
            <div class="form-group">
                <label for="system-prompt">系统提示词</label>
                <textarea id="system-prompt">你是一个有帮助的AI助手。请用中文回答用户的问题，保持友好和专业的态度。</textarea>
            </div>
            
            <div class="form-group">
                <label for="model">模型选择</label>
                <select id="model">
                    <option value="nalang-xl-10">NaLang XL-10</option>
                    <option value="nalang-xl-16k">NaLang XL-16K</option>
                    <option value="nalang-turbo-v18">NaLang Turbo v18</option>
                    <option value="nalang-turbo-v19">NaLang Turbo v19</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="temperature">温度 (0-2)</label>
                <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.7">
            </div>
            
            <div class="form-group">
                <label for="max-tokens">最大令牌数</label>
                <input type="number" id="max-tokens" min="100" max="2000" value="800">
            </div>
            
            <div class="form-group">
                <label for="top-p">Top P (0-1)</label>
                <input type="number" id="top-p" min="0" max="1" step="0.05" value="0.35">
            </div>
            
            <div class="form-group">
                <label for="repetition-penalty">重复惩罚</label>
                <input type="number" id="repetition-penalty" min="1" max="2" step="0.05" value="1.05">
            </div>
            
            <div class="form-group">
                <label>语音设置</label>
                <select id="voice-select">
                    <option value="">默认语音</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="voice-rate">语速 (0.1-2)</label>
                <input type="range" id="voice-rate" min="0.1" max="2" step="0.1" value="1">
                <span id="voice-rate-value">1</span>
            </div>
            
            <div class="form-group">
                <label for="voice-pitch">音调 (0.1-2)</label>
                <input type="range" id="voice-pitch" min="0.1" max="2" step="0.1" value="1">
                <span id="voice-pitch-value">1</span>
            </div>
            
            <div class="form-group">
                <label>当前状态: <span class="status-indicator status-inactive" id="status-indicator"></span> <span id="status-text2">准备就绪</span></label>
            </div>
            
            <!-- 导入导出功能 -->
            <div class="form-group">
                <label>数据管理</label>
                <div class="import-export">
                    <button class="import-btn" id="import-btn">
                        <i class="fas fa-file-import"></i> 导入数据
                    </button>
                    <button class="export-btn" id="export-btn">
                        <i class="fas fa-file-export"></i> 导出数据
                    </button>
                </div>
                <input type="file" id="file-input" accept=".json">
            </div>
            
            <button class="send-button" style="border-radius: 8px; width: 100%; margin-top: 10px;" id="reset-btn">
                <i class="fas fa-redo"></i> 重新设置
            </button>
        </div>
        
        <button class="settings-button" id="settings-btn">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <script>
        // 状态管理
        let isStreaming = false;
        let controller = null;
        let tokenCount = 0;
        let conversationHistory = [
            // { role: 'assistant', content: '您好！我是NaLang AI助手，支持完整的TTS功能和数据导入导出功能。', time: '12:00' },
            // { role: 'assistant', content: '您可以在设置面板中导入导出完整的聊天记录和系统设置。', time: '12:00' }
        ];
        
        // TTS相关变量
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let voices = [];
        let isSpeaking = false;
        
        // DOM元素
        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const settingsBtn = document.getElementById('settings-btn');
        const apiSettings = document.getElementById('api-settings');
        const closeSettings = document.getElementById('close-settings');
        const resetBtn = document.getElementById('reset-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const statusText2 = document.getElementById('status-text2');
        const tokenCountElement = document.getElementById('token-count');
        const ttsPlayBtn = document.getElementById('tts-play');
        const ttsPauseBtn = document.getElementById('tts-pause');
        const ttsStopBtn = document.getElementById('tts-stop');
        const voiceSelect = document.getElementById('voice-select');
        const voiceRate = document.getElementById('voice-rate');
        const voiceRateValue = document.getElementById('voice-rate-value');
        const voicePitch = document.getElementById('voice-pitch');
        const voicePitchValue = document.getElementById('voice-pitch-value');
        const voiceBtn = document.getElementById('voice-btn');
        const ttsStatus = document.getElementById('tts-status');
        const voiceWave = document.getElementById('voice-wave');
        const modelSelect = document.getElementById('model');
        const modelDisplay = document.getElementById('model-display');
        const messageCount = document.getElementById('message-count');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const fileInput = document.getElementById('file-input');
        const ttsWarning = document.getElementById('tts-warning');
        const systemPrompt = document.getElementById('system-prompt');
        const temperature = document.getElementById('temperature');
        const maxTokens = document.getElementById('max-tokens');
        const topP = document.getElementById('top-p');
        const repetitionPenalty = document.getElementById('repetition-penalty');
        
        // 初始化语音
        function initVoices() {
            // 检查浏览器是否支持TTS
            if (!window.speechSynthesis) {
                ttsWarning.innerHTML = '<p><strong>TTS不兼容：</strong> 您的浏览器不支持语音合成功能。请使用最新版的Chrome、Edge或Safari浏览器。</p>';
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 浏览器不支持';
                return;
            }
            
            // 获取语音列表
            voices = speechSynthesis.getVoices();
            
            // 如果语音列表为空，则等待voiceschanged事件
            if (voices.length === 0) {
                speechSynthesis.addEventListener('voiceschanged', function() {
                    voices = speechSynthesis.getVoices();
                    populateVoiceList();
                });
            } else {
                populateVoiceList();
            }
        }
        
        function populateVoiceList() {
            // 清空语音选择框
            voiceSelect.innerHTML = '<option value="">默认语音</option>';
            
            // 填充语音选项
            voices.forEach((voice, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // 设置默认语音（中文优先）
            const chineseVoices = voices.filter(voice => 
                voice.lang.includes('zh') || voice.lang.includes('CN') || voice.lang.includes('Chinese')
            );
            
            if (chineseVoices.length > 0) {
                // 优先选择中文语音
                const chineseVoice = chineseVoices.find(v => v.lang.includes('CN') && v.name.includes('Chinese')) || 
                                   chineseVoices.find(v => v.lang.includes('zh-CN')) || 
                                   chineseVoices[0];
                const index = voices.indexOf(chineseVoice);
                voiceSelect.value = index;
            }
            
            console.log('语音列表初始化完成', voices);
        }

        // 更新状态
        function updateStatus(status, text) {
            statusIndicator.className = 'status-indicator';
            
            switch(status) {
                case 'active':
                    statusIndicator.classList.add('status-active');
                    break;
                case 'inactive':
                    statusIndicator.classList.add('status-inactive');
                    break;
                case 'error':
                    statusIndicator.classList.add('status-error');
                    break;
            }
            
            statusText.textContent = text;
            statusText2.textContent = text;
        }
        
        // 添加消息到聊天界面
        function addMessage(role, content, customTime = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            
            const time = customTime || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-actions">
                    <div class="message-action" title="朗读">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
                <div class="content">${content}</div>
                <div class="time">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 添加事件监听器
            const actionBtn = messageDiv.querySelector('.message-action');
            actionBtn.addEventListener('click', () => {
                speakMessage(content);
            });
            
            // 添加到历史记录
            conversationHistory.push({ role, content, time });
            
            // 更新消息计数
            messageCount.textContent = conversationHistory.length;
        }
        
        // 显示输入中状态
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div>AI正在输入...</div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 隐藏输入中状态
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // 朗读消息
        function speakMessage(text) {
            // 检查浏览器是否支持语音合成
            if (!window.speechSynthesis) {
                showNotification('您的浏览器不支持语音合成功能', true);
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 浏览器不支持';
                return;
            }
            
            // 停止当前语音
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
            }
            
            // 创建新的语音实例
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // 设置语音参数
            const selectedVoiceIndex = parseInt(voiceSelect.value);
            if (!isNaN(selectedVoiceIndex) && voices[selectedVoiceIndex]) {
                currentUtterance.voice = voices[selectedVoiceIndex];
            } else {
                // 如果没有选择语音，则使用第一个可用的中文语音
                const chineseVoices = voices.filter(voice => 
                    voice.lang.includes('zh') || voice.lang.includes('CN') || voice.lang.includes('Chinese')
                );
                
                if (chineseVoices.length > 0) {
                    currentUtterance.voice = chineseVoices[0];
                }
            }
            
            currentUtterance.rate = parseFloat(voiceRate.value);
            currentUtterance.pitch = parseFloat(voicePitch.value);
            currentUtterance.lang = 'zh-CN';
            
            // 事件监听器
            currentUtterance.onstart = () => {
                isSpeaking = true;
                ttsPlayBtn.disabled = true;
                ttsPauseBtn.disabled = false;
                ttsStopBtn.disabled = false;
                updateStatus('active', '语音播放中');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 播放中';
                voiceWave.style.display = 'flex';
            };
            
            currentUtterance.onend = () => {
                isSpeaking = false;
                ttsPlayBtn.disabled = false;
                ttsPauseBtn.disabled = true;
                ttsStopBtn.disabled = true;
                updateStatus('inactive', '在线');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 播放完成';
                voiceWave.style.display = 'none';
            };
            
            currentUtterance.onerror = (event) => {
                console.error('语音合成错误:', event);
                isSpeaking = false;
                ttsPlayBtn.disabled = false;
                ttsPauseBtn.disabled = true;
                ttsStopBtn.disabled = true;
                updateStatus('error', '语音错误');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 错误';
                voiceWave.style.display = 'none';
                showNotification('语音播放失败: ' + event.error, true);
            };
            
            try {
                // 开始朗读
                speechSynthesis.speak(currentUtterance);
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 开始播放...';
            } catch (error) {
                console.error('播放失败:', error);
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 播放失败';
                showNotification('语音播放失败: ' + error.message, true);
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            if (!userMessage || isStreaming) return;
            
            // 添加用户消息
            addMessage('user', userMessage);
            messageInput.value = '';
            
            // 显示输入中状态
            showTypingIndicator();
            
            // 更新状态
            updateStatus('active', '思考中...');
            isStreaming = true;
            
            // 构建消息历史
            const messages = [
                { role: 'system', content: systemPrompt.value }
            ];
            
            // 添加对话历史
            conversationHistory.forEach(msg => {
                messages.push({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.content
                });
            });
            
            // 构建请求体
            const requestBody = {
                model: modelSelect.value,
                messages: messages,
                stream: true,
                temperature: parseFloat(temperature.value),
                max_tokens: parseInt(maxTokens.value),
                top_p: parseFloat(topP.value),
                repetition_penalty: parseFloat(repetitionPenalty.value)
            };
            
            // 创建AbortController以便可以取消请求
            controller = new AbortController();
            
            try {
                // 发送请求
                const response = await fetch('https://www.gpt4novel.com/api/xiaoshuoai/ext/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 97ca1ce9-8107-4dc7-afc5-e346b4a3d5bd'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                // 处理流式响应
                updateStatus('active', '回复中...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let assistantMessage = '';
                tokenCount = 0;
                
                // 移除输入中状态
                hideTypingIndicator();
                
                // 创建新的消息容器
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'assistant');
                messageDiv.innerHTML = `
                    <div class="message-actions">
                        <div class="message-action" title="朗读">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </div>
                    <div class="content"></div>
                    <div class="time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                `;
                chatMessages.appendChild(messageDiv);
                
                const contentDiv = messageDiv.querySelector('.content');
                const actionBtn = messageDiv.querySelector('.message-action');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // 处理缓冲区中的完整行
                    let newlineIndex;
                    while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
                        const line = buffer.slice(0, newlineIndex);
                        buffer = buffer.slice(newlineIndex + 1);
                        
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonData = JSON.parse(line.slice(6).trim());
                                
                                // 处理内容块
                                if (jsonData.choices?.[0]?.delta?.content) {
                                    const content = jsonData.choices[0].delta.content;
                                    assistantMessage += content;
                                    tokenCount++;
                                    
                                    // 更新UI
                                    contentDiv.innerHTML = assistantMessage;
                                    tokenCountElement.textContent = tokenCount;
                                    
                                    // 滚动到底部
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } catch (e) {
                                // 忽略空行导致的解析错误
                                if (line.trim()) {
                                    console.error('解析JSON错误:', e);
                                }
                            }
                        }
                    }
                }
                
                // 添加事件监听器
                actionBtn.addEventListener('click', () => {
                    speakMessage(assistantMessage);
                });
                
                // 添加到对话历史
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                conversationHistory.push({ role: 'assistant', content: assistantMessage, time });
                
                // 更新消息计数
                messageCount.textContent = conversationHistory.length;
                
                // 流结束
                updateStatus('inactive', '在线');
                isStreaming = false;
                
                // 自动朗读最新消息
                speakMessage(assistantMessage);
            } catch (error) {
                hideTypingIndicator();
                
                if (error.name === 'AbortError') {
                    updateStatus('inactive', '已取消');
                    addMessage('assistant', '响应已取消');
                } else {
                    console.error('错误:', error);
                    updateStatus('error', '错误发生');
                    addMessage('assistant', `错误: ${error.message}`);
                }
                isStreaming = false;
            }
        }
        
        // 重置对话
        function resetConversation() {
            conversationHistory = [
                // { role: 'assistant', content: '您好！我是NaLang AI助手，支持完整的TTS功能和数据导入导出功能。', time: '12:00' },
                // { role: 'assistant', content: '您可以在设置面板中导入导出完整的聊天记录和系统设置。', time: '12:00' }
            ];
            
            renderConversation();
            
            tokenCount = 0;
            tokenCountElement.textContent = '0';
            messageCount.textContent = conversationHistory.length;
            updateStatus('inactive', '在线');
            ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 准备就绪';
            voiceWave.style.display = 'none';
            
            showNotification('对话已重置');
        }
        
        // 渲染对话
        function renderConversation() {
            chatMessages.innerHTML = '';
            
            conversationHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', msg.role);
                
                messageDiv.innerHTML = `
                    <div class="message-actions">
                        <div class="message-action" title="朗读">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </div>
                    <div class="content">${msg.content}</div>
                    <div class="time">${msg.time}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
                
                // 添加事件监听器
                const actionBtn = messageDiv.querySelector('.message-action');
                actionBtn.addEventListener('click', () => {
                    speakMessage(msg.content);
                });
            });
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 导出完整数据
        function exportFullData() {
            // 收集所有需要保存的数据
            const exportData = {
                meta: {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    appName: "AI聊天"
                },
                conversationHistory: conversationHistory,
                settings: {
                    systemPrompt: systemPrompt.value,
                    model: modelSelect.value,
                    temperature: temperature.value,
                    maxTokens: maxTokens.value,
                    topP: topP.value,
                    repetitionPenalty: repetitionPenalty.value,
                    voiceSettings: {
                        voiceIndex: voiceSelect.value,
                        rate: voiceRate.value,
                        pitch: voicePitch.value
                    }
                },
                tokenCount: tokenCount
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `chat-full-data-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('完整数据已导出');
        }
        
        // 导入完整数据
        function importFullData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 验证导入的数据格式
                    if (!importedData.conversationHistory || !importedData.settings) {
                        throw new Error('无效的数据格式');
                    }
                    
                    // 恢复对话历史
                    conversationHistory = importedData.conversationHistory;
                    
                    // 恢复设置
                    systemPrompt.value = importedData.settings.systemPrompt || systemPrompt.value;
                    modelSelect.value = importedData.settings.model || modelSelect.value;
                    temperature.value = importedData.settings.temperature || temperature.value;
                    maxTokens.value = importedData.settings.maxTokens || maxTokens.value;
                    topP.value = importedData.settings.topP || topP.value;
                    repetitionPenalty.value = importedData.settings.repetitionPenalty || repetitionPenalty.value;
                    
                    // 恢复语音设置
                    if (importedData.settings.voiceSettings) {
                        voiceSelect.value = importedData.settings.voiceSettings.voiceIndex || voiceSelect.value;
                        voiceRate.value = importedData.settings.voiceSettings.rate || voiceRate.value;
                        voicePitch.value = importedData.settings.voiceSettings.pitch || voicePitch.value;
                        voiceRateValue.textContent = voiceRate.value;
                        voicePitchValue.textContent = voicePitch.value;
                    }
                    
                    // 恢复令牌计数
                    tokenCount = importedData.tokenCount || 0;
                    tokenCountElement.textContent = tokenCount;
                    
                    // 更新模型显示
                    modelDisplay.textContent = modelSelect.options[modelSelect.selectedIndex].text;
                    
                    // 渲染对话
                    renderConversation();
                    
                    // 更新消息计数
                    messageCount.textContent = conversationHistory.length;
                    
                    showNotification('完整数据已导入');
                } catch (error) {
                    console.error('导入错误:', error);
                    showNotification('导入失败: ' + error.message, true);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入，允许再次导入同一文件
            event.target.value = '';
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (isError) {
                notification.style.background = '#dc3545';
            }
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // 初始化语音识别
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('您的浏览器不支持语音识别功能，请使用Chrome浏览器');
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            voiceBtn.addEventListener('click', () => {
                if (voiceBtn.classList.contains('listening')) {
                    recognition.stop();
                    voiceBtn.classList.remove('listening');
                } else {
                    recognition.start();
                    voiceBtn.classList.add('listening');
                    ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 正在聆听...';
                }
            });
            
            recognition.onstart = () => {
                messageInput.placeholder = "正在聆听...";
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                messageInput.placeholder = "输入消息...";
                voiceBtn.classList.remove('listening');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 识别完成';
            };
            
            recognition.onerror = (event) => {
                console.error('语音识别错误:', event.error);
                messageInput.placeholder = "输入消息...";
                voiceBtn.classList.remove('listening');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 识别错误 - ' + event.error;
            };
            
            recognition.onend = () => {
                messageInput.placeholder = "输入消息...";
                voiceBtn.classList.remove('listening');
            };
        }
        
        // 事件监听
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        settingsBtn.addEventListener('click', () => {
            apiSettings.classList.toggle('active');
        });
        
        closeSettings.addEventListener('click', () => {
            apiSettings.classList.remove('active');
        });
        
        resetBtn.addEventListener('click', resetConversation);
        
        // TTS按钮事件
        ttsPlayBtn.addEventListener('click', () => {
            if (conversationHistory.length > 0) {
                const lastMessage = conversationHistory[conversationHistory.length - 1].content;
                speakMessage(lastMessage);
            }
        });
        
        ttsPauseBtn.addEventListener('click', () => {
            if (isSpeaking) {
                speechSynthesis.pause();
                ttsPauseBtn.disabled = true;
                ttsPlayBtn.disabled = false;
                updateStatus('inactive', '已暂停');
                ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 已暂停';
                voiceWave.style.display = 'none';
            }
        });
        
        ttsStopBtn.addEventListener('click', () => {
            speechSynthesis.cancel();
            isSpeaking = false;
            ttsPlayBtn.disabled = false;
            ttsPauseBtn.disabled = true;
            ttsStopBtn.disabled = true;
            updateStatus('inactive', '在线');
            ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 已停止';
            voiceWave.style.display = 'none';
        });
        
        // 语音设置事件
        voiceRate.addEventListener('input', () => {
            voiceRateValue.textContent = voiceRate.value;
        });
        
        voicePitch.addEventListener('input', () => {
            voicePitchValue.textContent = voicePitch.value;
        });
        
        // 模型选择事件
        modelSelect.addEventListener('change', () => {
            modelDisplay.textContent = modelSelect.options[modelSelect.selectedIndex].text;
        });
        
        // 导入导出事件
        exportBtn.addEventListener('click', exportFullData);
        importBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', importFullData);
        
        // 初始化
        updateStatus('inactive', '在线');
        ttsStatus.querySelector('span:first-child').textContent = 'TTS状态: 准备就绪';
        voiceWave.style.display = 'none';
        messageCount.textContent = conversationHistory.length;
        modelDisplay.textContent = modelSelect.options[modelSelect.selectedIndex].text;
        
        // 初始化语音
        window.addEventListener('load', () => {
            // 初始化语音列表
            initVoices();
            
            // 初始化语音识别
            initSpeechRecognition();
            
            // 渲染初始对话
            renderConversation();
        });
    </script>
</body>
</html>
